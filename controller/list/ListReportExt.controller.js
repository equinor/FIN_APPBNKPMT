/*
 * Copyright (C) 2009-2020 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/InvisibleText","fin/ap/approvebankpayments/model/batchDraft","fin/ap/approvebankpayments/model/formatter","fin/ap/approvebankpayments/model/ListViewModel","fin/ap/approvebankpayments/model/Messaging","fin/ap/approvebankpayments/controller/ConfirmUndoDialog","fin/ap/approvebankpayments/controller/list/ConfirmMasterActionDialog","fin/ap/approvebankpayments/controller/list/ConfirmSubmitDialog","fin/ap/approvebankpayments/model/PopoverHandler"],function(I,B,f,L,M,C,a,b,P){"use strict";var _={tab1Suffix:"-_tab1_ForReview",tab2Suffix:"-_tab2_Reviewed",tableId:"responsiveTable",smartTableId:"listReport",iconTabBarId:"template::IconTabBar",toolbar:{approveId:"approveBatches",rejectId:"rejectBatches",deferId:"deferBatches",returnId:"returnBatches",submitId:"submitBatches",undoId:"undoBatches",deleteId:"deleteEntry"}};var c=M;function d(m,D){c.logError(m,D,"fin.ap.approvebankpayments.controller.list.ListReportExt");}function g(k){var l={};var i;for(i=0;i<k.length;i++){l[k[i].getPath()]=Promise.resolve();}return{busy:{set:true,check:true},mConsiderObjectsAsDeleted:l};}function e(m,i){return{getModel:function(){return this._model;},getObject:function(){return this._data;},getPath:function(){return this._path;},getProperty:function(p){return this._data[p];},_data:i,_model:m,_path:"/"+m.createKey("C_AbpPaymentBatch",i)};}function h(i){var s=i.sibling.getId();var k=s.substring(0,s.lastIndexOf("--")+2);var p=i.sibling.getParent();var l=new I(k+i.id,{text:i.text});p.addContent(l);}function j(){this.formatter=f;this._viewModel=L;this._batchDraft=B;}j.prototype.onInit=function(){var i=this.getOwnerComponent();this._initSubComponents(i.getModel("@i18n").getResourceBundle());i.setModel(this._viewModel.getModel(),this._viewModel.getModelName());this._popoverHandler=new P(this.getView());this._initSmartFilterBar();this._adjustActions();this._initTables();this._provideHiddenTexts();c.subscribeEvent(c.eventName.BATCH_ACTION,this.onBatchEdited,this);};j.prototype.onBatchEdited=function(){this.extensionAPI.refreshTable();this._fetchReviewedCount();};j.prototype.onExit=function(){this._popoverHandler.onExit();c.unsubscribeEvent(c.eventName.BATCH_ACTION,this.onBatchEdited,this);};j.prototype.onBeforeRebindTableExtension=function(E){var o=E.getParameter("bindingParams");this._viewModel.ensureColumnDependencies(o.parameters);this._viewModel.applyCustomFilters(o);this._fetchReviewedCount();};j.prototype.getCustomAppStateDataExtension=function(o){this._viewModel.saveCustomState(o);};j.prototype.restoreCustomAppStateDataExtension=function(o){this._viewModel.restoreCustomState(o);};j.prototype.onSelectionChanged=function(E){var t=E.getSource();var i=t.getItems();this._viewModel.onSelectionChanged(t.getSelectedItems());if(!this._deferDaysPeriod&&i.length>0){this._deferDaysPeriod=i[0].getBindingContext().getObject().ResubmissionDays;}};j.prototype.onIconTabChange=function(E){var t=this.byId(_.tableId+"-"+E.getParameter("key"));var i=t.getBinding("items");this._viewModel.setIsForReviewTab(E.getParameter("key")==="_tab1_ForReview");if(i){i.refresh();}};j.prototype.onSubmitBatches=function(){var i=this.extensionAPI.getSelectedContexts();var k=i[0].getProperty("AuthenticationType");this._submitReviewed(i,k,"L");};j.prototype.onSubmitReviewed=function(){c.actionStarted(this._getText("masterSubmitReviewed"));this.extensionAPI.securedExecution(this._getBatchProps.bind(this)).then(function(i){var k=i.results[0].AuthenticationType;var l=this._getContextsFromBatchesData(i);this._submitReviewed(l,k);}.bind(this)).catch(this._onActionFailure.bind(this));};j.prototype.onMoreHouseBanksPress=function(E){this._popoverHandler.onMoreHouseBanksPress(E);};j.prototype.onMoreAccountsPress=function(E){this._popoverHandler.onMoreAccountsPress(E);};j.prototype.onMoreApymentAmountsPress=function(E){this._popoverHandler.onMoreApymentAmountsPress(E);};j.prototype.onBeforeHouseBankPopoverOpens=function(E){this._popoverHandler.onBeforeHouseBankPopoverOpens(E);};j.prototype.onAccountNavigationTargetsObtained=function(E){this._popoverHandler.onAccountNavigationTargetsObtained(E);};j.prototype.onHouseBankNavigationTargetsObtained=function(E){this._popoverHandler.onHouseBankNavigationTargetsObtained(E);};j.prototype.onHouseBankNavigationTargetsObtainedList=function(E){this._popoverHandler.onHouseBankNavigationTargetsObtainedList(E);};j.prototype.onBeforeAccountPopoverOpens=function(E){this._popoverHandler.onBeforeAccountPopoverOpens(E);};j.prototype.onCreatedByPress=function(E){this._popoverHandler.onCreatedByPress(E);};j.prototype.onApproveBatches=function(){this._multiSelectEdit("app");};j.prototype.onRejectBatches=function(){this._multiSelectEdit("rej");};j.prototype.onDeferBatches=function(){this._multiSelectEdit("def");};j.prototype.onReturnBatches=function(){this._multiSelectEdit("ret");};j.prototype.onUndoBatches=function(){this._confirmUndo().then(function(i){c.actionStarted(this._getText("masterSelectedBatchesUndo"));var k=this.extensionAPI.getSelectedContexts();var l=k[0].getProperty("PaymentBatch");this.extensionAPI.securedExecution(this._batchDraft.undoBatches.bind(this,k,i)).then(this._onActionSuccess.bind(this,"undoBatchesChagesSuccess",k,"undoBatchChagesSuccess",l),g(k)).catch(this._onActionFailure.bind(this));}.bind(this)).catch(this._onActionFailure.bind(this));};j.prototype._getBatchProps=function(){return new Promise(function(r,R){var m=this.getOwnerComponent().getModel();m.read("/C_AbpPaymentBatch/",{filters:this._viewModel.getReviewedTabFilters(),urlParameters:{"$select":"PaymentBatch,DraftUUID,IsActiveEntity,AuthenticationType"},success:r,error:R});}.bind(this));};j.prototype._initSubComponents=function(i){this.formatter.setResourceBundle(i);this._viewModel.init(i);this._batchDraft.setResourceBundle(i);c.setReourceBundle(i);};j.prototype._initTables=function(){var t=this.byId(_.smartTableId+_.tab1Suffix).getParent();var i=this.byId(_.tableId+_.tab1Suffix);var k=this.byId(_.tableId+_.tab2Suffix);this.byId(_.iconTabBarId).attachSelect(this.onIconTabChange.bind(this));[_.tab1Suffix,_.tab2Suffix].forEach(function(l){var s=this.byId(_.smartTableId+l);s.setRequestAtLeastFields(this._viewModel.getAllwaysRequestFields());s.setIgnoredFields(this._viewModel.getIgnoredFields());s.setUseExportToExcel(true);}.bind(this));i.attachSelectionChange(this.onSelectionChanged,this);i.attachUpdateFinished(this.onSelectionChanged,this);k.attachSelectionChange(this.onSelectionChanged,this);k.attachUpdateFinished(this.onSelectionChanged,this);b.addSubmitAllMessageStrip(t,this);};j.prototype._onActionSuccess=function(m,i,k,s){var l=i.length>1?this._getText(m,i.length):this._getText(k,s);c.actionFinished(l);this._refreshAfterAction();};j.prototype._onActionFailure=function(i){if(i){c.addActionError(i);c.actionFinished();this._refreshAfterAction();}};j.prototype._adjustActions=function(){this._hideToolbarItem(_.toolbar.deleteId+_.tab1Suffix);this._hideToolbarItem(_.toolbar.submitId+_.tab1Suffix);[_.toolbar.deleteId,_.toolbar.approveId,_.toolbar.rejectId,_.toolbar.deferId,_.toolbar.returnId].forEach(function(i){this._hideToolbarItem(i+_.tab2Suffix);}.bind(this));this._setDefferButtonVisibility();this._bindTab1Enabled(_.toolbar.rejectId,"firstStageActionsAvailable");this._bindTab1Enabled(_.toolbar.deferId,"isDeferEnabled");this._bindTab1Enabled(_.toolbar.returnId,"nextStageActionsAvailable");this._bindTab1Enabled(_.toolbar.undoId,"undoAvailable");this._bindTabEnabled(_.tab2Suffix,_.toolbar.undoId,"undoAvailable");};j.prototype._submitReviewed=function(i,k,s){new b(this.getView(),k,s).then(function(l){c.actionStarted(this._getText("masterSubmitReviewed"));this.extensionAPI.securedExecution(this._submitReviewedByData.bind(this,i,l),g(i)).catch(this._onActionFailure.bind(this));}.bind(this)).catch(this._onActionFailure.bind(this));};j.prototype._multiSelectEdit=function(A){var i=this.extensionAPI.getSelectedContexts();this._confirmAction(A,i).then(function(o){c.actionStarted(this._getActionText(A));var t=o.takeOver;var k=this._getEditableContexts(i,t);var l=k[0].getProperty("PaymentBatch");this.extensionAPI.securedExecution(this._batchDraft.processBatches.bind(this,k,o,t),g(k)).then(this._onActionSuccess.bind(this,"editBatchesSuccess",k,"editBatchSuccess",l)).catch(this._onActionFailure.bind(this));}.bind(this)).catch(this._onActionFailure.bind(this));};j.prototype._getActionText=function(A){var i={"app":"masterSelectedBatchesApprove","def":"masterSelectedBatchesDefer","rej":"masterSelectedBatchesReject","ret":"masterSelectedBatchesReturn"};return this._getText(i[A]);};j.prototype._refreshAfterAction=function(){this.extensionAPI.refreshTable();this._fetchReviewedCount();};j.prototype._fetchReviewedCount=function(){var m=this.getOwnerComponent().getModel();m.read("/C_AbpPaymentBatch/$count",{filters:this._viewModel.getReviewedTabFilters(),success:function(i){this._viewModel.setReviewedCount(i);}.bind(this),error:function(E){this._viewModel.setReviewedCount("0");d("Failed to load reviewed batches.",E);}.bind(this)});};j.prototype._getContextsFromBatchesData=function(D){var m=this.getOwnerComponent().getModel();return D.results.map(function(i){var k={PaymentBatch:i.PaymentBatch,DraftUUID:i.DraftUUID,IsActiveEntity:i.IsActiveEntity};return e(m,k);});};j.prototype._submitReviewedByData=function(i,k){var l=i[0].getProperty("PaymentBatch");return this._batchDraft.submitReviewed(i,k).then(this._onActionSuccess.bind(this,"submitBatchesSuccess",i,"submitBatchSuccess",l)).catch(this._onActionFailure.bind(this));};j.prototype._getEditableContexts=function(A,t){return A.filter(function(i){return!i.getProperty("IsActiveEntity")||!i.getProperty("HasDraftEntity")||t&&!i.getProperty("DraftAdministrativeData/InProcessByUser");});};j.prototype._confirmAction=function(A,i){var k=new Date();if(this._deferDaysPeriod){k.setDate(k.getDate()+this._deferDaysPeriod);}return new a(this.getView(),{action:A,isDefer:A==="def",isReject:A==="rej",deferDate:k,deferMinDate:new Date(),note:""},i);};j.prototype._confirmUndo=function(){var i=this.extensionAPI.getSelectedContexts();return new C(this.getView(),i);};j.prototype._getText=function(){var i=this.getOwnerComponent().getModel("@i18n").getResourceBundle();return i.getText.apply(i,arguments);};j.prototype._bindTab1Enabled=function(i,p){this._bindTabEnabled(_.tab1Suffix,i,p);};j.prototype._bindTabEnabled=function(t,i,p){var k=this.byId(i+t);k.bindProperty("enabled",{path:"/"+p,model:this._viewModel.getModelName()});};j.prototype._hideToolbarItem=function(i){var k=this.byId(i);if(k){k.setVisible(false);}};j.prototype._setDefferButtonVisibility=function(){var i=this.byId(_.toolbar.deferId+_.tab1Suffix);if(i){i.setVisible(this.formatter.deferButtonVisibility(this.getOwnerComponent().getModel()));}};j.prototype._initSmartFilterBar=function(){var s=this.byId("listReportFilter");if(s){s.setUseDateRangeType(true);}};j.prototype._provideHiddenTexts=function(){var s=this.byId("listReportFilter");var i=[{id:"houseBankColumnHeaderText",sibling:s,text:"{/#C_AbpPaymentBatchType/HouseBank/@sap:label}"},{id:"houseBankAccountColumnHeaderText",sibling:s,text:"{/#C_AbpPaymentBatchType/HouseBankAccount/@sap:label}"},{id:"paidAmountInPaytCurrencyColumnHeaderText",sibling:s,text:"{/#C_AbpPaymentBatchType/PaidAmountInPaytCurrency/@sap:label}"}];if(s){i.forEach(h);}};return sap.ui.controller("fin.ap.approvebankpayments.controller.list.ListReportExt",new j());},true);
