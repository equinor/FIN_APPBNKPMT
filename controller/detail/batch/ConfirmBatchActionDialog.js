/*
 * Copyright (C) 2009-2020 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","sap/ui/Global","sap/ui/model/json/JSONModel","fin/ap/approvebankpayments/model/formatter"],function(q,P,U,J,f){"use strict";var C="fin.ap.approvebankpayments.view.batch.ConfirmActionDialog";return P.extend("fin.ap.approvebankpayments.controller.detail.batch.ConfirmBatchActionDialog",{formatter:f,constructor:function(v,a,b,p){var m=new J(a);var A={"app":"masterSelectedBatchesApprove","def":"masterSelectedBatchesDefer","rej":"masterSelectedBatchesReject","ret":"masterSelectedBatchesReturn"};this._oBatchBinding=b;this._aPayments=p;this._oDeffered=q.Deferred();this._oDialog=U.xmlfragment(v.createId("ConfirmActionDialog"),C,this);this._oView=v;this._sAction=a.action;this._sActionText=this.getResourceBundle().getText(A[a.action]);this._isRejectWithNote=a.isReject;this._oView.addDependent(this._oDialog);m.setProperty("/actionEnabled",false);this._oDialog.setModel(m,"action");},getPromise:function(){var t=this.getResourceBundle().getText("userConfirmDialogBatchTitle",[this._sActionText]);this._getActionModel().setProperty("/title",t);this.getStatistic();this._oDialog.open();return this._oDeffered;},getStatistic:function(){var s=new J({isMaster:false});var a=this._oBatchBinding.getProperty("ApprovalIsFirst")||this._oBatchBinding.getProperty("IsReturnedApproval");var p=this._oBatchBinding.getProperty("NumberOfPayments");var b=a&&(!this._aPayments||this._aPayments.length!==p);var c;this._oDialog.setModel(s,"stats");s.setProperty("/mismatchError",false);s.setProperty("/reading",b);if(b){this._readServerStatistics();}else if(!a){s.setProperty("/"+this._sAction,p);this._getActionModel().setProperty("/actionEnabled",this._canSubmit());}else{c=this._aPayments.map(function(d){return d.getBindingContext().getProperty("PaymentAction");});this._processPaymentsActions(c);}},getResourceBundle:function(){return this._oView.getModel("@i18n").getResourceBundle();},onConfirmDialogOkPress:function(){var m=this._getActionModel();var a={action:this._sAction,note:m.getProperty("/note"),isDefer:m.getProperty("/isDefer"),deferDate:this.formatter.dateTimeToDate(m.getProperty("/deferDate"))};this._oDeffered.resolve(a);this._oDialog.close();},onConfirmDialogCancelPress:function(){this._oDeffered.reject();this._oDialog.close();},onAfterClose:function(){this._oDialog.destroy();},handleLiveChange:function(e){var n=e.getParameter("value").length===0;var i=this._getActionModel().getProperty("/isReject");if(i){this._setRejWithNote(n);}},_readServerStatistics:function(){var p=this._oBatchBinding.getPath();var r={success:function(d){var a=d.results.map(function(b){return b.PaymentAction;});this._processPaymentsActions(a);}.bind(this),urlParameters:{"$select":"PaymentAction"}};this._oBatchBinding.getModel().read(p+"/to_Payment",r);},_processPaymentsActions:function(a){var s=this._oDialog.getModel("stats");a.forEach(function(A){var b=A?A:this._sAction;var Q=s.getProperty("/"+b)||0;s.setProperty("/"+b,Q+1);},this);this._finalizeStatisticsRead();},_finalizeStatisticsRead:function(){var s=this._oDialog.getModel("stats");var a=this._getActionModel();if(!a.getProperty("/isReject")&&s.getProperty("/rej")){a.setProperty("/isReject",true);this._setRejWithNote(!a.getProperty("/note"));}s.setProperty("/reading",false);if(!this._setEnableSubmitButton()){s.setProperty("/mismatchError",true);}},_canSubmit:function(){return!this._isRejectWithNote;},_setEnableSubmitButton:function(){var a=this._getActionModel();var s=this._oDialog.getModel("stats");var b=!!s.getProperty("/"+this._sAction);a.setProperty("/actionEnabled",b&&this._canSubmit());return b;},_setRejWithNote:function(e){this._isRejectWithNote=e;this._setEnableSubmitButton();},_getActionModel:function(){return this._oDialog.getModel("action");}});});
